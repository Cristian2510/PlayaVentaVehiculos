{% extends "base.html" %}

{% block title %}CRM - Gestión de Clientes{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Gestión de Clientes</h5>
                        <button class="btn btn-primary" onclick="openModal('nuevoClienteModal')">
                            <i class="fas fa-plus me-2"></i>Nuevo Cliente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 id="totalClientes">0</h3>
                        <p>Total Clientes</p>
                    </div>
                    <i class="fas fa-users fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 id="clientesActivos">0</h3>
                        <p>Clientes Activos</p>
                    </div>
                    <i class="fas fa-user-check fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 id="comprasTotales">0</h3>
                        <p>Compras Totales</p>
                    </div>
                    <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 id="valorPromedio">₲ 0</h3>
                        <p>Valor Promedio</p>
                    </div>
                    <i class="fas fa-chart-line fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Buscar</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Nombre, cédula, email...">
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Estado</label>
                            <select class="form-select" id="estadoFilter">
                                <option value="">Todos</option>
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label class="form-label">Ordenar por</label>
                            <select class="form-select" id="ordenFilter">
                                <option value="fecha">Fecha Registro</option>
                                <option value="nombre">Nombre</option>
                                <option value="compras">Compras</option>
                                <option value="valor">Valor Total</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button class="btn btn-secondary me-2" onclick="clearFilters()">
                                <i class="fas fa-times me-2"></i>Limpiar
                            </button>
                            <button class="btn btn-primary" onclick="exportarClientes()">
                                <i class="fas fa-download me-2"></i>Exportar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clients Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="clientesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Cédula</th>
                                    <th>Teléfono</th>
                                    <th>Email</th>
                                    <th>Compras</th>
                                    <th>Valor Total</th>
                                    <th>Última Compra</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clientesTableBody">
                                <!-- Se llenará dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo Cliente -->
<div class="modal fade" id="nuevoClienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="nuevoClienteForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" name="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido *</label>
                            <input type="text" class="form-control" name="apellido" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cédula *</label>
                            <input type="text" class="form-control" name="cedula" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control" name="telefono">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <textarea class="form-control" name="direccion" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCliente()">
                    <i class="fas fa-save me-2"></i>Guardar Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Cliente -->
<div class="modal fade" id="editarClienteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-edit me-2"></i>Editar Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editarClienteForm">
                    <input type="hidden" name="id" id="editClienteId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control" name="nombre" id="editNombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Apellido *</label>
                            <input type="text" class="form-control" name="apellido" id="editApellido" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cédula *</label>
                            <input type="text" class="form-control" name="cedula" id="editCedula" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="text" class="form-control" name="telefono" id="editTelefono">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" id="editEmail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <textarea class="form-control" name="direccion" id="editDireccion" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" name="observaciones" id="editObservaciones" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="actualizarCliente()">
                    <i class="fas fa-save me-2"></i>Actualizar Cliente
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Detalles Cliente -->
<div class="modal fade" id="verDetallesClienteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user me-2"></i>Detalles del Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Información Personal</h6>
                        <table class="table table-sm">
                            <tr><td><strong>ID:</strong></td><td id="detalleClienteId"></td></tr>
                            <tr><td><strong>Nombre:</strong></td><td id="detalleClienteNombre"></td></tr>
                            <tr><td><strong>Cédula:</strong></td><td id="detalleClienteCedula"></td></tr>
                            <tr><td><strong>Teléfono:</strong></td><td id="detalleClienteTelefono"></td></tr>
                            <tr><td><strong>Email:</strong></td><td id="detalleClienteEmail"></td></tr>
                            <tr><td><strong>Dirección:</strong></td><td id="detalleClienteDireccion"></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Información Comercial</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Total Compras:</strong></td><td id="detalleClienteCompras"></td></tr>
                            <tr><td><strong>Valor Total:</strong></td><td id="detalleClienteValor"></td></tr>
                            <tr><td><strong>Última Compra:</strong></td><td id="detalleClienteUltimaCompra"></td></tr>
                            <tr><td><strong>Fecha Registro:</strong></td><td id="detalleClienteFechaRegistro"></td></tr>
                            <tr><td><strong>Estado:</strong></td><td id="detalleClienteEstado"></td></tr>
                        </table>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Historial de Compras</h6>
                        <div class="table-responsive">
                            <table class="table table-sm" id="historialComprasTable">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Vehículo</th>
                                        <th>Precio</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="historialComprasBody">
                                    <!-- Se llenará dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="editarClienteDesdeDetalles()">
                    <i class="fas fa-edit me-2"></i>Editar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let clientes = [];
let clientesFiltrados = [];
let ventas = [];

// Cargar datos de CRM
async function loadCRMData() {
    try {
        // Cargar clientes
        const clientesResponse = await fetch('/api/clientes');
        clientes = await clientesResponse.json();

        // Cargar ventas
        const ventasResponse = await fetch('/api/ventas');
        ventas = await ventasResponse.json();

        clientesFiltrados = [...clientes];
        renderClientes();
        updateStatistics();
        
    } catch (error) {
        console.error('Error cargando datos de CRM:', error);
    }
}

// Renderizar tabla de clientes
function renderClientes() {
    const tbody = document.getElementById('clientesTableBody');
    tbody.innerHTML = '';

    clientesFiltrados.forEach(cliente => {
        const comprasCliente = ventas.filter(v => v.cliente_id === cliente.id);
        const valorTotal = comprasCliente.reduce((total, v) => total + v.precio_venta, 0);
        const ultimaCompra = comprasCliente.length > 0 ? 
            comprasCliente.sort((a, b) => new Date(b.fecha_venta) - new Date(a.fecha_venta))[0].fecha_venta : '-';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${cliente.id}</td>
            <td>${cliente.nombre} ${cliente.apellido}</td>
            <td>${cliente.cedula}</td>
            <td>${cliente.telefono || '-'}</td>
            <td>${cliente.email || '-'}</td>
            <td>${comprasCliente.length}</td>
            <td>₲ ${valorTotal.toLocaleString()}</td>
            <td>${ultimaCompra}</td>
            <td>
                <span class="badge ${comprasCliente.length > 0 ? 'badge-success' : 'badge-warning'}">
                    ${comprasCliente.length > 0 ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-info" onclick="verDetallesCliente(${cliente.id})" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="editarCliente(${cliente.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-success" onclick="nuevaVentaCliente(${cliente.id})" title="Nueva venta">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="eliminarCliente(${cliente.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Actualizar estadísticas
function updateStatistics() {
    const total = clientes.length;
    const activos = clientes.filter(c => {
        const comprasCliente = ventas.filter(v => v.cliente_id === c.id);
        return comprasCliente.length > 0;
    }).length;
    const comprasTotales = ventas.length;
    const valorPromedio = ventas.length > 0 ? 
        ventas.reduce((total, v) => total + v.precio_venta, 0) / ventas.length : 0;

    document.getElementById('totalClientes').textContent = total;
    document.getElementById('clientesActivos').textContent = activos;
    document.getElementById('comprasTotales').textContent = comprasTotales;
    document.getElementById('valorPromedio').textContent = `₲ ${valorPromedio.toLocaleString()}`;
}

// Aplicar filtros
function aplicarFiltros() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const estadoFilter = document.getElementById('estadoFilter').value;
    const ordenFilter = document.getElementById('ordenFilter').value;

    clientesFiltrados = clientes.filter(cliente => {
        const comprasCliente = ventas.filter(v => v.cliente_id === cliente.id);
        const esActivo = comprasCliente.length > 0;
        
        const matchesSearch = !searchTerm || 
            cliente.nombre.toLowerCase().includes(searchTerm) ||
            cliente.apellido.toLowerCase().includes(searchTerm) ||
            cliente.cedula.toLowerCase().includes(searchTerm) ||
            (cliente.email && cliente.email.toLowerCase().includes(searchTerm));
        
        const matchesEstado = !estadoFilter || 
            (estadoFilter === 'Activo' && esActivo) ||
            (estadoFilter === 'Inactivo' && !esActivo);

        return matchesSearch && matchesEstado;
    });

    // Ordenar
    clientesFiltrados.sort((a, b) => {
        const comprasA = ventas.filter(v => v.cliente_id === a.id);
        const comprasB = ventas.filter(v => v.cliente_id === b.id);
        const valorA = comprasA.reduce((total, v) => total + v.precio_venta, 0);
        const valorB = comprasB.reduce((total, v) => total + v.precio_venta, 0);

        switch(ordenFilter) {
            case 'nombre':
                return (a.nombre + ' ' + a.apellido).localeCompare(b.nombre + ' ' + b.apellido);
            case 'compras':
                return comprasB.length - comprasA.length;
            case 'valor':
                return valorB - valorA;
            default:
                return new Date(b.fecha_registro) - new Date(a.fecha_registro);
        }
    });

    renderClientes();
}

// Limpiar filtros
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('estadoFilter').value = '';
    document.getElementById('ordenFilter').value = '';
    clientesFiltrados = [...clientes];
    renderClientes();
}

// Exportar clientes
function exportarClientes() {
    // Implementar exportación a Excel/PDF
    alert('Función de exportación en desarrollo');
}

// Abrir modal
function openModal(modalId) {
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();
}

// Guardar cliente
async function guardarCliente() {
    const form = document.getElementById('nuevoClienteForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/api/clientes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            alert('Cliente guardado exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('nuevoClienteModal')).hide();
            form.reset();
            loadCRMData();
        } else {
            alert('Error al guardar el cliente');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar el cliente');
    }
}

// Editar cliente
function editarCliente(id) {
    const cliente = clientes.find(c => c.id === id);
    if (!cliente) return;

    // Llenar formulario
    document.getElementById('editClienteId').value = cliente.id;
    document.getElementById('editNombre').value = cliente.nombre;
    document.getElementById('editApellido').value = cliente.apellido;
    document.getElementById('editCedula').value = cliente.cedula;
    document.getElementById('editTelefono').value = cliente.telefono || '';
    document.getElementById('editEmail').value = cliente.email || '';
    document.getElementById('editDireccion').value = cliente.direccion || '';
    document.getElementById('editObservaciones').value = cliente.observaciones || '';

    openModal('editarClienteModal');
}

// Actualizar cliente
async function actualizarCliente() {
    const form = document.getElementById('editarClienteForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch(`/api/clientes/${data.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();
        if (result.success) {
            alert('Cliente actualizado exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('editarClienteModal')).hide();
            loadCRMData();
        } else {
            alert('Error al actualizar el cliente');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al actualizar el cliente');
    }
}

// Ver detalles del cliente
function verDetallesCliente(id) {
    const cliente = clientes.find(c => c.id === id);
    if (!cliente) return;

    const comprasCliente = ventas.filter(v => v.cliente_id === cliente.id);
    const valorTotal = comprasCliente.reduce((total, v) => total + v.precio_venta, 0);
    const ultimaCompra = comprasCliente.length > 0 ? 
        comprasCliente.sort((a, b) => new Date(b.fecha_venta) - new Date(a.fecha_venta))[0].fecha_venta : '-';

    // Llenar detalles
    document.getElementById('detalleClienteId').textContent = cliente.id;
    document.getElementById('detalleClienteNombre').textContent = `${cliente.nombre} ${cliente.apellido}`;
    document.getElementById('detalleClienteCedula').textContent = cliente.cedula;
    document.getElementById('detalleClienteTelefono').textContent = cliente.telefono || '-';
    document.getElementById('detalleClienteEmail').textContent = cliente.email || '-';
    document.getElementById('detalleClienteDireccion').textContent = cliente.direccion || '-';
    document.getElementById('detalleClienteCompras').textContent = comprasCliente.length;
    document.getElementById('detalleClienteValor').textContent = `₲ ${valorTotal.toLocaleString()}`;
    document.getElementById('detalleClienteUltimaCompra').textContent = ultimaCompra;
    document.getElementById('detalleClienteFechaRegistro').textContent = cliente.fecha_registro;
    document.getElementById('detalleClienteEstado').textContent = comprasCliente.length > 0 ? 'Activo' : 'Inactivo';

    // Llenar historial de compras
    const historialBody = document.getElementById('historialComprasBody');
    historialBody.innerHTML = '';

    comprasCliente.forEach(venta => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${venta.fecha_venta}</td>
            <td>${venta.vehiculo_marca} ${venta.vehiculo_modelo}</td>
            <td>₲ ${venta.precio_venta.toLocaleString()}</td>
            <td>
                <span class="badge ${venta.estado_pago === 'Pagado' ? 'badge-success' : 'badge-warning'}">
                    ${venta.estado_pago}
                </span>
            </td>
        `;
        historialBody.appendChild(row);
    });

    openModal('verDetallesClienteModal');
}

// Editar cliente desde detalles
function editarClienteDesdeDetalles() {
    const clienteId = document.getElementById('detalleClienteId').textContent;
    editarCliente(clienteId);
}

// Nueva venta para cliente
function nuevaVentaCliente(id) {
    // Redirigir a la página de facturación
    window.location.href = `/facturacion?cliente=${id}`;
}

// Eliminar cliente
async function eliminarCliente(id) {
    if (!confirm('¿Está seguro de que desea eliminar este cliente?')) return;

    try {
        const response = await fetch(`/api/clientes/${id}`, {
            method: 'DELETE'
        });

        const result = await response.json();
        if (result.success) {
            alert('Cliente eliminado exitosamente');
            loadCRMData();
        } else {
            alert('Error al eliminar el cliente');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar el cliente');
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    loadCRMData();

    // Filtros
    document.getElementById('searchInput').addEventListener('input', aplicarFiltros);
    document.getElementById('estadoFilter').addEventListener('change', aplicarFiltros);
    document.getElementById('ordenFilter').addEventListener('change', aplicarFiltros);
});
</script>
{% endblock %} 